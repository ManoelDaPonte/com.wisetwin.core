using System;
using UnityEngine;
using UnityEditor;
using System.IO;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;
using System.Threading.Tasks;
using Newtonsoft.Json;
using UnityEngine.SceneManagement;

#if UNITY_EDITOR

public class WiseTwinEditor : EditorWindow
{
    // Centralized data container
    private WiseTwin.Editor.WiseTwinEditorData data;
    private string settingsFilePath;

    // UI State
    private int selectedTab = 0;
    private string[] tabNames = { "General Settings", "Metadata Config", "Scenario Configuration" };
    
    
    [MenuItem("WiseTwin/WiseTwin Editor")]
    public static void ShowWindow()
    {
        WiseTwinEditor window = GetWindow<WiseTwinEditor>("WiseTwin Editor");
        window.minSize = new Vector2(700, 600);
        window.Show();
    }
    
    void OnEnable()
    {
        // Initialize data container
        data = new WiseTwin.Editor.WiseTwinEditorData();

        settingsFilePath = Path.Combine(Application.persistentDataPath, "WiseTwinSettings.json");
        LoadSettings();
        LoadLanguagePreference();
        InitializeSceneId();

        // Synchroniser automatiquement avec WiseTwinManager au chargement
        EditorApplication.delayCall += () =>
        {
            SyncWithSceneManager();
        };
        LoadExistingJSONContent();
        InitializeUnityContent();
    }
    
    void LoadLanguagePreference()
    {
        string savedLanguage = PlayerPrefs.GetString("WiseTwin_Language", "en");
        for (int i = 0; i < data.languageCodes.Length; i++)
        {
            if (data.languageCodes[i] == savedLanguage)
            {
                data.selectedLanguageIndex = i;
                break;
            }
        }
    }
    
    void LoadSettings()
    {
        if (File.Exists(settingsFilePath))
        {
            try
            {
                string jsonContent = File.ReadAllText(settingsFilePath);
                var settingsDict = JsonConvert.DeserializeObject<Dictionary<string, object>>(jsonContent);

                if (settingsDict.ContainsKey("useLocalMode"))
                    data.useLocalMode = (bool)settingsDict["useLocalMode"];
                if (settingsDict.ContainsKey("azureApiUrl"))
                    data.azureApiUrl = settingsDict["azureApiUrl"].ToString();
                if (settingsDict.ContainsKey("containerId"))
                    data.containerId = settingsDict["containerId"].ToString();
                if (settingsDict.ContainsKey("buildType"))
                    data.buildType = settingsDict["buildType"].ToString();
                if (settingsDict.ContainsKey("requestTimeout"))
                    data.requestTimeout = Convert.ToSingle(settingsDict["requestTimeout"]);
                if (settingsDict.ContainsKey("maxRetryAttempts"))
                    data.maxRetryAttempts = Convert.ToInt32(settingsDict["maxRetryAttempts"]);
                if (settingsDict.ContainsKey("enableDebugLogs"))
                    data.enableDebugLogs = (bool)settingsDict["enableDebugLogs"];

            }
            catch (System.Exception e)
            {
                Debug.LogWarning($"[WiseTwin] Could not load settings: {e.Message}");
            }
        }
    }
    
    void SaveSettings()
    {
        try
        {
            var settingsDict = new Dictionary<string, object>
            {
                ["useLocalMode"] = data.useLocalMode,
                ["azureApiUrl"] = data.azureApiUrl,
                ["containerId"] = data.containerId,
                ["buildType"] = data.buildType,
                ["requestTimeout"] = data.requestTimeout,
                ["maxRetryAttempts"] = data.maxRetryAttempts,
                ["enableDebugLogs"] = data.enableDebugLogs
            };

            string jsonContent = JsonConvert.SerializeObject(settingsDict, Formatting.Indented);
            File.WriteAllText(settingsFilePath, jsonContent);

        }
        catch (System.Exception e)
        {
            Debug.LogError($"[WiseTwin] Could not save settings: {e.Message}");
        }
    }
    
    
    void InitializeSceneId()
    {
        // Get current scene name
        data.sceneId = SceneManager.GetActiveScene().name;
        if (string.IsNullOrEmpty(data.sceneId))
        {
            data.sceneId = "default-scene";
        }
    }
    
    void LoadExistingJSONContent()
    {
        string targetFileName = $"{data.sceneId}-metadata.json";

        // Possible paths to search for JSON file
        string[] possiblePaths = {
            Path.Combine(Application.streamingAssetsPath, targetFileName),
            Path.Combine(Application.streamingAssetsPath, "metadata.json"), // Fallback
        };

        string foundPath = null;
        foreach (string path in possiblePaths)
        {
            if (File.Exists(path))
            {
                foundPath = path;
                break;
            }
        }

        if (foundPath != null)
        {
            try
            {
                string jsonContent = File.ReadAllText(foundPath);
                ParseExistingJSON(jsonContent);
                data.currentLoadedFile = Path.GetFileName(foundPath);
                data.hasLoadedExistingJSON = true;

            }
            catch (System.Exception e)
            {
                Debug.LogError($"‚ùå Error loading JSON: {e.Message}");
                data.hasLoadedExistingJSON = false;
            }
        }
        else
        {
            data.hasLoadedExistingJSON = false;
        }
    }
    
    void ParseExistingJSON(string jsonContent)
    {
        try
        {
            var metadata = JsonConvert.DeserializeObject<FormationMetadataComplete>(jsonContent);

            // Load basic data - g√©rer les objets multilingues
            if (metadata.title != null)
            {
                data.projectTitleEN = metadata.title.en ?? "Training Test";
                data.projectTitleFR = metadata.title.fr ?? "Formation Test";
            }
            if (metadata.description != null)
            {
                data.projectDescriptionEN = metadata.description.en ?? "Training description";
                data.projectDescriptionFR = metadata.description.fr ?? "Description de la formation";
            }
            if (!string.IsNullOrEmpty(metadata.version)) data.projectVersion = metadata.version;
            if (!string.IsNullOrEmpty(metadata.imageUrl)) data.imageUrl = metadata.imageUrl;

            // Parse duration (extract numbers)
            if (!string.IsNullOrEmpty(metadata.duration))
            {
                ParseDurationFromString(metadata.duration);
            }

            // Parse difficulty (find index)
            if (!string.IsNullOrEmpty(metadata.difficulty))
            {
                ParseDifficultyFromString(metadata.difficulty);
            }

            // Load lists
            if (metadata.tags != null && metadata.tags.Count > 0)
                data.tags = new List<string>(metadata.tags);

            // üéØ IMPORTANT: Extract Unity section (object content)
            if (metadata.unity != null)
            {
                // Convert Unity content directly to formatted JSON
                data.unityContentJSON = JsonConvert.SerializeObject(metadata.unity, Formatting.Indented);
                ValidateUnityContent();

            }
            else
            {
                InitializeUnityContent();
            }

            // üéØ NEW: Load scenarios if present
            if (metadata.scenarios != null && metadata.scenarios.Count > 0)
            {
                LoadScenariosFromJSON(metadata.scenarios);
                Debug.Log($"‚úÖ Loaded {data.scenarios.Count} scenarios from metadata");
            }
        }
        catch (System.Exception e)
        {
            Debug.LogError($"‚ùå Error parsing existing JSON: {e.Message}");
            InitializeUnityContent();
        }
    }

    void LoadScenariosFromJSON(List<object> scenariosJSON)
    {
        data.scenarios.Clear();

        foreach (var scenarioObj in scenariosJSON)
        {
            try
            {
                var scenarioDict = scenarioObj as Dictionary<string, object>;
                if (scenarioDict == null)
                {
                    var jObject = Newtonsoft.Json.Linq.JObject.FromObject(scenarioObj);
                    scenarioDict = jObject.ToObject<Dictionary<string, object>>();
                }

                var scenario = new WiseTwin.Editor.ScenarioConfiguration();

                // Load basic fields
                if (scenarioDict.ContainsKey("id"))
                    scenario.id = scenarioDict["id"]?.ToString();

                if (scenarioDict.ContainsKey("type"))
                {
                    string typeStr = scenarioDict["type"]?.ToString();
                    if (Enum.TryParse<WiseTwin.Editor.ScenarioType>(typeStr, true, out var type))
                        scenario.type = type;
                }

                if (scenarioDict.ContainsKey("evaluationMode"))
                    scenario.evaluationMode = Convert.ToBoolean(scenarioDict["evaluationMode"]);

                // Load content based on type
                switch (scenario.type)
                {
                    case WiseTwin.Editor.ScenarioType.Question:
                        if (scenarioDict.ContainsKey("question"))
                            LoadQuestionDataFromJSON(scenario.questionData, scenarioDict["question"]);
                        break;

                    case WiseTwin.Editor.ScenarioType.Procedure:
                        if (scenarioDict.ContainsKey("procedure"))
                            LoadProcedureDataFromJSON(scenario.procedureData, scenarioDict["procedure"]);
                        break;

                    case WiseTwin.Editor.ScenarioType.Text:
                        if (scenarioDict.ContainsKey("text"))
                            LoadTextDataFromJSON(scenario.textData, scenarioDict["text"]);
                        break;
                }

                data.scenarios.Add(scenario);
            }
            catch (System.Exception e)
            {
                Debug.LogWarning($"‚ö†Ô∏è Failed to load scenario: {e.Message}");
            }
        }
    }

    void LoadQuestionDataFromJSON(WiseTwin.Editor.QuestionScenarioData question, object questionObj)
    {
        var jObject = Newtonsoft.Json.Linq.JObject.FromObject(questionObj);
        var questionDict = jObject.ToObject<Dictionary<string, object>>();

        // Load question text
        if (questionDict.ContainsKey("questionText"))
        {
            var textDict = GetDictionary(questionDict["questionText"]);
            question.questionTextEN = GetString(textDict, "en");
            question.questionTextFR = GetString(textDict, "fr");
        }

        // Load options
        if (questionDict.ContainsKey("options"))
        {
            var optionsDict = GetDictionary(questionDict["options"]);
            question.optionsEN = GetStringList(optionsDict, "en");
            question.optionsFR = GetStringList(optionsDict, "fr");
        }

        // Load correct answers
        if (questionDict.ContainsKey("correctAnswers"))
        {
            var correctAnswersObj = questionDict["correctAnswers"];
            if (correctAnswersObj is Newtonsoft.Json.Linq.JArray jArray)
            {
                question.correctAnswers = jArray.ToObject<List<int>>();
            }
        }

        // Load flags
        if (questionDict.ContainsKey("isMultipleChoice"))
            question.isMultipleChoice = Convert.ToBoolean(questionDict["isMultipleChoice"]);

        // Load feedback
        if (questionDict.ContainsKey("feedback"))
        {
            var feedbackDict = GetDictionary(questionDict["feedback"]);
            question.feedbackEN = GetString(feedbackDict, "en");
            question.feedbackFR = GetString(feedbackDict, "fr");
        }

        if (questionDict.ContainsKey("incorrectFeedback"))
        {
            var feedbackDict = GetDictionary(questionDict["incorrectFeedback"]);
            question.incorrectFeedbackEN = GetString(feedbackDict, "en");
            question.incorrectFeedbackFR = GetString(feedbackDict, "fr");
        }

        // Load hint
        if (questionDict.ContainsKey("hint"))
        {
            var hintDict = GetDictionary(questionDict["hint"]);
            question.hintEN = GetString(hintDict, "en");
            question.hintFR = GetString(hintDict, "fr");
        }
    }

    void LoadProcedureDataFromJSON(WiseTwin.Editor.ProcedureScenarioData procedure, object procedureObj)
    {
        var jObject = Newtonsoft.Json.Linq.JObject.FromObject(procedureObj);
        var procedureDict = jObject.ToObject<Dictionary<string, object>>();

        // Load title
        if (procedureDict.ContainsKey("title"))
        {
            var titleDict = GetDictionary(procedureDict["title"]);
            procedure.titleEN = GetString(titleDict, "en");
            procedure.titleFR = GetString(titleDict, "fr");
        }

        // Load description
        if (procedureDict.ContainsKey("description"))
        {
            var descDict = GetDictionary(procedureDict["description"]);
            procedure.descriptionEN = GetString(descDict, "en");
            procedure.descriptionFR = GetString(descDict, "fr");
        }

        // Load settings
        if (procedureDict.ContainsKey("allowSkipSteps"))
            procedure.allowSkipSteps = Convert.ToBoolean(procedureDict["allowSkipSteps"]);
        if (procedureDict.ContainsKey("showStepNumbers"))
            procedure.showStepNumbers = Convert.ToBoolean(procedureDict["showStepNumbers"]);
        if (procedureDict.ContainsKey("requireSequentialOrder"))
            procedure.requireSequentialOrder = Convert.ToBoolean(procedureDict["requireSequentialOrder"]);

        // Load steps
        if (procedureDict.ContainsKey("steps"))
        {
            LoadProcedureStepsFromJSON(procedure.steps, procedureDict["steps"]);
        }

        // Load fake objects
        if (procedureDict.ContainsKey("fakeObjects"))
        {
            LoadFakeObjectsFromJSON(procedure.fakeObjects, procedureDict["fakeObjects"]);
        }
    }

    void LoadProcedureStepsFromJSON(List<WiseTwin.Editor.ProcedureStep> steps, object stepsObj)
    {
        steps.Clear();

        if (stepsObj is Newtonsoft.Json.Linq.JArray jArray)
        {
            foreach (var stepObj in jArray)
            {
                var step = new WiseTwin.Editor.ProcedureStep();
                var stepDict = stepObj.ToObject<Dictionary<string, object>>();

                // Load text
                if (stepDict.ContainsKey("text"))
                {
                    var textDict = GetDictionary(stepDict["text"]);
                    step.textEN = GetString(textDict, "en");
                    step.textFR = GetString(textDict, "fr");
                }

                // Load target object name
                if (stepDict.ContainsKey("targetObjectName"))
                    step.targetObjectName = stepDict["targetObjectName"]?.ToString();

                // Load highlight color
                if (stepDict.ContainsKey("highlightColor"))
                {
                    string colorHex = stepDict["highlightColor"]?.ToString();
                    if (!string.IsNullOrEmpty(colorHex) && ColorUtility.TryParseHtmlString(colorHex, out Color color))
                        step.highlightColor = color;
                }

                // Load blinking
                if (stepDict.ContainsKey("useBlinking"))
                    step.useBlinking = Convert.ToBoolean(stepDict["useBlinking"]);

                // Load hint
                if (stepDict.ContainsKey("hint"))
                {
                    var hintDict = GetDictionary(stepDict["hint"]);
                    step.hintEN = GetString(hintDict, "en");
                    step.hintFR = GetString(hintDict, "fr");
                }

                steps.Add(step);
            }
        }
    }

    void LoadFakeObjectsFromJSON(List<WiseTwin.Editor.FakeObject> fakeObjects, object fakeObjectsObj)
    {
        fakeObjects.Clear();

        if (fakeObjectsObj is Newtonsoft.Json.Linq.JArray jArray)
        {
            foreach (var fakeObj in jArray)
            {
                var fake = new WiseTwin.Editor.FakeObject();
                var fakeDict = fakeObj.ToObject<Dictionary<string, object>>();

                // Load object name
                if (fakeDict.ContainsKey("objectName"))
                    fake.fakeObjectName = fakeDict["objectName"]?.ToString();

                // Load error message
                if (fakeDict.ContainsKey("errorMessage"))
                {
                    var errorDict = GetDictionary(fakeDict["errorMessage"]);
                    fake.errorMessageEN = GetString(errorDict, "en");
                    fake.errorMessageFR = GetString(errorDict, "fr");
                }

                fakeObjects.Add(fake);
            }
        }
    }

    void LoadTextDataFromJSON(WiseTwin.Editor.TextScenarioData text, object textObj)
    {
        var jObject = Newtonsoft.Json.Linq.JObject.FromObject(textObj);
        var textDict = jObject.ToObject<Dictionary<string, object>>();

        // Load title
        if (textDict.ContainsKey("title"))
        {
            var titleDict = GetDictionary(textDict["title"]);
            text.titleEN = GetString(titleDict, "en");
            text.titleFR = GetString(titleDict, "fr");
        }

        // Load content
        if (textDict.ContainsKey("content"))
        {
            var contentDict = GetDictionary(textDict["content"]);
            text.contentEN = GetString(contentDict, "en");
            text.contentFR = GetString(contentDict, "fr");
        }
    }

    // Helper methods for JSON parsing
    Dictionary<string, object> GetDictionary(object obj)
    {
        if (obj is Dictionary<string, object> dict)
            return dict;

        if (obj is Newtonsoft.Json.Linq.JObject jObj)
            return jObj.ToObject<Dictionary<string, object>>();

        return new Dictionary<string, object>();
    }

    string GetString(Dictionary<string, object> dict, string key)
    {
        return dict.ContainsKey(key) ? dict[key]?.ToString() ?? "" : "";
    }

    List<string> GetStringList(Dictionary<string, object> dict, string key)
    {
        if (!dict.ContainsKey(key))
            return new List<string>();

        var obj = dict[key];
        if (obj is Newtonsoft.Json.Linq.JArray jArray)
            return jArray.ToObject<List<string>>();

        return new List<string>();
    }
    
    void ParseDurationFromString(string durationStr)
    {
        try
        {
            // Extract numbers from string (e.g., "30 minutes" -> 30)
            string numbersOnly = System.Text.RegularExpressions.Regex.Match(durationStr, @"\d+").Value;
            if (!string.IsNullOrEmpty(numbersOnly))
            {
                data.durationMinutes = int.Parse(numbersOnly);
            }
        }
        catch
        {
            data.durationMinutes = 30; // default value
        }
    }

    void ParseDifficultyFromString(string difficultyStr)
    {
        for (int i = 0; i < data.difficultyOptions.Length; i++)
        {
            if (string.Equals(data.difficultyOptions[i], difficultyStr, System.StringComparison.OrdinalIgnoreCase))
            {
                data.difficultyIndex = i;
                return;
            }
        }
        data.difficultyIndex = 1; // Default "Intermediate"
    }
    
    void InitializeUnityContent()
    {
        if (string.IsNullOrEmpty(data.unityContentJSON))
        {
            data.unityContentJSON = JsonConvert.SerializeObject(new Dictionary<string, object>(), Formatting.Indented);
        }
        ValidateUnityContent();
    }

    void ValidateUnityContent()
    {
        try
        {
            if (!string.IsNullOrEmpty(data.unityContentJSON))
            {
                JsonConvert.DeserializeObject(data.unityContentJSON);
                data.isUnityContentValid = true;
            }
        }
        catch
        {
            data.isUnityContentValid = false;
        }
    }
    
    void OnGUI()
    {
        DrawHeader();
        DrawLoadedFileInfo();
        DrawTabs();

        data.scrollPosition = EditorGUILayout.BeginScrollView(data.scrollPosition);

        switch (selectedTab)
        {
            case 0:
                WiseTwin.Editor.WiseTwinEditorGeneralTab.Draw(data, this);
                break;
            case 1:
                WiseTwin.Editor.WiseTwinEditorMetadataTab.Draw(data);
                break;
            case 2:
                WiseTwin.Editor.WiseTwinEditorScenariosTab.Draw(data);
                break;
        }

        EditorGUILayout.EndScrollView();

        DrawBottomButtons();
    }
    
    void DrawHeader()
    {
        EditorGUILayout.Space();
        EditorGUI.DrawRect(EditorGUILayout.GetControlRect(false, 2), new Color(0.3f, 0.6f, 1f));
        EditorGUILayout.Space();

        EditorGUILayout.BeginHorizontal();
        GUILayout.Label("üéØ", GUILayout.Width(30));
        EditorGUILayout.LabelField("WiseTwin Editor", EditorStyles.largeLabel);

        // Language selector in top-right corner
        GUILayout.FlexibleSpace();
        GUILayout.Label("üåê", GUILayout.Width(20));
        int newLanguageIndex = EditorGUILayout.Popup(data.selectedLanguageIndex, data.supportedLanguages, GUILayout.Width(100));
        if (newLanguageIndex != data.selectedLanguageIndex)
        {
            data.selectedLanguageIndex = newLanguageIndex;
            // Save language preference for runtime
            PlayerPrefs.SetString("WiseTwin_Language", data.languageCodes[data.selectedLanguageIndex]);
            PlayerPrefs.Save();
        }
        EditorGUILayout.EndHorizontal();

        EditorGUILayout.LabelField("Centralized management for WiseTwin Unity projects", EditorStyles.helpBox);
        EditorGUILayout.Space();
    }
    
    void DrawLoadedFileInfo()
    {
        EditorGUILayout.BeginVertical("box");
        EditorGUILayout.LabelField($"üéØ Scene: {data.sceneId} (current active scene)", EditorStyles.boldLabel);

        if (data.hasLoadedExistingJSON)
        {
            EditorGUILayout.BeginHorizontal();
            EditorGUILayout.LabelField($"üìÑ Loaded file: {data.currentLoadedFile}", EditorStyles.helpBox);
            if (GUILayout.Button("üîÑ Reload", GUILayout.Width(100)))
            {
                LoadExistingJSONContent();
            }
            EditorGUILayout.EndHorizontal();
        }
        else
        {
            EditorGUILayout.LabelField("‚ÑπÔ∏è No JSON file found. Creating new content.", EditorStyles.helpBox);
        }
        EditorGUILayout.EndVertical();
        EditorGUILayout.Space();
    }
    
    void DrawTabs()
    {
        selectedTab = GUILayout.Toolbar(selectedTab, tabNames, GUILayout.Height(25));
        EditorGUILayout.Space();
    }

    // ============================================================
    // Tab drawing methods have been extracted to separate files:
    // - WiseTwinEditorGeneralTab.cs
    // - WiseTwinEditorMetadataTab.cs
    // - WiseTwinEditorScenariosTab.cs
    // ============================================================

    void DrawBottomButtons()
    {
        EditorGUILayout.Space();
        EditorGUILayout.BeginVertical("box");
        
        // Environment Mode
        EditorGUILayout.LabelField("Environment Configuration", EditorStyles.boldLabel);
        bool newUseLocalMode = EditorGUILayout.Toggle("Use Local Mode", useLocalMode);
        if (newUseLocalMode != useLocalMode)
        {
            useLocalMode = newUseLocalMode;
            EditorUtility.SetDirty(this);
            // Appliquer imm√©diatement au WiseTwinManager dans la sc√®ne
            ApplyLocalModeToManager();
        }
        
        EditorGUILayout.HelpBox(
            useLocalMode ?
            "üè† Local Mode: Will load metadata from StreamingAssets folder\n‚ö†Ô∏è Les changements sont appliqu√©s automatiquement √† la sc√®ne" :
            "‚òÅÔ∏è Production Mode: Will load metadata from Azure API\n‚úÖ Les changements sont appliqu√©s automatiquement √† la sc√®ne",
            MessageType.Info);

        // Afficher l'√©tat actuel du WiseTwinManager
        WiseTwin.WiseTwinManager currentManager = FindFirstObjectByType<WiseTwin.WiseTwinManager>();
        if (currentManager != null)
        {
            bool currentProdMode = currentManager.IsProductionMode();
            if (currentProdMode == useLocalMode) // Si d√©synchronis√©
            {
                EditorGUILayout.HelpBox(
                    "‚ö†Ô∏è Synchronisation en cours avec WiseTwinManager...",
                    MessageType.Warning);
            }
        }
        else
        {
            EditorGUILayout.HelpBox(
                "‚ö†Ô∏è WiseTwinManager non trouv√© dans la sc√®ne. Ajoutez-le via 'Setup Scene' ci-dessous.",
                MessageType.Warning);
        }

        EditorGUILayout.Space(10);

        // Bouton pour appliquer les settings aux GameObjects de la sc√®ne
        GUI.backgroundColor = new Color(0.2f, 0.8f, 0.5f);
        if (GUILayout.Button("üîß Apply Settings to Scene Objects", GUILayout.Height(30)))
        {
            ApplySettingsToScene();
        }
        GUI.backgroundColor = Color.white;

        // Bouton pour t√©l√©charger les m√©tadonn√©es depuis l'API
        EditorGUILayout.Space(10);
        GUI.backgroundColor = new Color(0.3f, 0.7f, 1f);
        if (GUILayout.Button("üì• Download Metadata from API", GUILayout.Height(30)))
        {
            DownloadMetadataFromAPI();
        }
        GUI.backgroundColor = Color.white;

        EditorGUILayout.Space(10);

        // Azure Configuration (only show if not in local mode)
        if (!useLocalMode)
        {
            EditorGUILayout.LabelField("‚òÅÔ∏è Azure Configuration", EditorStyles.boldLabel);

            // Toggle pour choisir entre API et Azure Storage direct
            useAzureStorageDirect = EditorGUILayout.Toggle("Use Azure Storage Direct", useAzureStorageDirect);

            if (useAzureStorageDirect)
            {
                EditorGUILayout.HelpBox("‚òÅÔ∏è Direct Azure Storage access (bypass API)", MessageType.Info);
                azureStorageUrl = EditorGUILayout.TextField("Storage URL", azureStorageUrl);
                if (GUILayout.Button("Example: https://yourstorage.blob.core.windows.net/", EditorStyles.miniLabel))
                {
                    azureStorageUrl = "https://yourstorage.blob.core.windows.net/";
                }
            }
            else
            {
                EditorGUILayout.HelpBox("üåê Using Next.js API endpoint", MessageType.Info);
                azureApiUrl = EditorGUILayout.TextField("API Base URL", azureApiUrl);
            }

            containerId = EditorGUILayout.TextField("Container ID", containerId);
            buildType = EditorGUILayout.TextField("Build Type", buildType);

            EditorGUILayout.Space(10);
        }
        
        // Debug Settings
        EditorGUILayout.LabelField("üêõ Debug Configuration", EditorStyles.boldLabel);
        enableDebugLogs = EditorGUILayout.Toggle("Enable Debug Logs", enableDebugLogs);
        requestTimeout = EditorGUILayout.FloatField("Request Timeout (s)", requestTimeout);
        maxRetryAttempts = EditorGUILayout.IntField("Max Retry Attempts", maxRetryAttempts);
        
        EditorGUILayout.EndVertical();
        
        EditorGUILayout.Space();
        
        // Project Information
        EditorGUILayout.LabelField("üìã Project Information", EditorStyles.boldLabel);
        EditorGUILayout.BeginVertical("box");
        
        EditorGUI.BeginDisabledGroup(true);
        EditorGUILayout.TextField("Scene Name", sceneId);
        EditorGUILayout.TextField("Company Name", Application.companyName);
        EditorGUILayout.TextField("Unity Version", Application.unityVersion);
        EditorGUI.EndDisabledGroup();
        
        EditorGUILayout.EndVertical();
        
        EditorGUILayout.Space();
        
    }
    
    
    void DrawMetadataConfigTab()
    {
        // Basic Settings
        EditorGUILayout.LabelField("üìã Basic Configuration", EditorStyles.boldLabel);
        EditorGUILayout.BeginVertical("box");
        
        // Scene ID (read-only, based on active scene)
        EditorGUI.BeginDisabledGroup(true);
        EditorGUILayout.TextField("Scene Name", sceneId);
        EditorGUI.EndDisabledGroup();
        EditorGUILayout.HelpBox($"Metadata will be saved as: {sceneId}-metadata.json", MessageType.Info);

        // Titre multilingue
        EditorGUILayout.Space(5);
        EditorGUILayout.LabelField("üìù Title (Multilingual)", EditorStyles.boldLabel);
        projectTitleEN = EditorGUILayout.TextField("üá¨üáß English", projectTitleEN);
        projectTitleFR = EditorGUILayout.TextField("üá´üá∑ Fran√ßais", projectTitleFR);

        // Description multilingue
        EditorGUILayout.Space(5);
        EditorGUILayout.LabelField("üìÑ Description (Multilingual)", EditorStyles.boldLabel);
        EditorGUILayout.LabelField("üá¨üáß English", EditorStyles.miniLabel);
        projectDescriptionEN = EditorGUILayout.TextArea(projectDescriptionEN, GUILayout.Height(60));
        EditorGUILayout.LabelField("üá´üá∑ Fran√ßais", EditorStyles.miniLabel);
        projectDescriptionFR = EditorGUILayout.TextArea(projectDescriptionFR, GUILayout.Height(60));
        
        projectVersion = EditorGUILayout.TextField("Version", projectVersion);
        
        // Duration in minutes (numeric field)
        EditorGUILayout.BeginHorizontal();
        durationMinutes = EditorGUILayout.IntField("Duration (minutes)", durationMinutes);
        EditorGUILayout.LabelField($"‚Üí {durationMinutes} minutes", EditorStyles.miniLabel, GUILayout.Width(100));
        EditorGUILayout.EndHorizontal();
        
        // Difficulty (dropdown)
        difficultyIndex = EditorGUILayout.Popup("Difficulty", difficultyIndex, difficultyOptions);
        
        imageUrl = EditorGUILayout.TextField("Image URL", imageUrl);
        
        EditorGUILayout.EndVertical();
        EditorGUILayout.Space();
        
        // Advanced Settings
        EditorGUILayout.LabelField("‚öôÔ∏è Advanced Settings", EditorStyles.boldLabel);
        EditorGUILayout.BeginVertical("box");
        
        DrawStringList("üè∑Ô∏è Tags", tags);
        
        EditorGUILayout.EndVertical();
    }
    
    // DEPRECATED: Unity Objects tab removed - now using Scenario Configuration
    /*
    void DrawUnityObjectsTab()
    {
        EditorGUILayout.LabelField("üéÆ Unity Objects Configuration", EditorStyles.boldLabel);

        // Unity Content Editor
        EditorGUILayout.BeginVertical("box");
        EditorGUILayout.LabelField("‚úèÔ∏è Unity Content Editor (JSON)", EditorStyles.boldLabel);
        EditorGUILayout.LabelField("Define objects and their contents (questions, interactions, etc.)", EditorStyles.helpBox);
        
        EditorGUILayout.BeginHorizontal();
        if (GUILayout.Button("üìã Copy", GUILayout.Width(80)))
        {
            EditorGUIUtility.systemCopyBuffer = unityContentJSON;
            ShowNotification(new GUIContent("JSON copied!"));
        }
        if (GUILayout.Button("üì• Paste", GUILayout.Width(80)))
        {
            unityContentJSON = EditorGUIUtility.systemCopyBuffer;
            ValidateUnityContent();
        }
        if (GUILayout.Button("üßπ Clear", GUILayout.Width(80)))
        {
            if (EditorUtility.DisplayDialog("Confirmation", "Are you sure you want to clear Unity content?", "Yes", "Cancel"))
            {
                unityContentJSON = "{}";
                ValidateUnityContent();
            }
        }
        if (GUILayout.Button("üéØ Example", GUILayout.Width(80)))
        {
            LoadExampleUnityContent();
        }
        EditorGUILayout.EndHorizontal();
        
        EditorGUILayout.Space(5);
        
        unityContentScrollPosition = EditorGUILayout.BeginScrollView(unityContentScrollPosition, GUILayout.Height(300));
        
        GUI.color = isUnityContentValid ? Color.white : new Color(1f, 0.8f, 0.8f);
        string newContent = EditorGUILayout.TextArea(unityContentJSON, GUILayout.ExpandHeight(true));
        GUI.color = Color.white;
        
        if (newContent != unityContentJSON)
        {
            unityContentJSON = newContent;
            ValidateUnityContent();
        }
        
        EditorGUILayout.EndScrollView();
        
        if (!isUnityContentValid)
        {
            EditorGUILayout.HelpBox("‚ùå Invalid JSON! Check syntax.", MessageType.Error);
        }
        else
        {
            EditorGUILayout.HelpBox("‚úÖ Valid JSON", MessageType.Info);
        }
        
        EditorGUILayout.Space();
        EditorGUILayout.LabelField("üí° Tips", EditorStyles.boldLabel);
        EditorGUILayout.LabelField("‚Ä¢ Use Unity object IDs as main keys", EditorStyles.helpBox);
        EditorGUILayout.LabelField("‚Ä¢ For multi-language: use {\"en\": \"English text\", \"fr\": \"Texte fran√ßais\"}", EditorStyles.helpBox);
        EditorGUILayout.LabelField("‚Ä¢ Language is selected automatically from the top-right dropdown", EditorStyles.helpBox);
        EditorGUILayout.LabelField("‚Ä¢ Examples: questions, dialogues, instructions, media, etc.", EditorStyles.helpBox);

        EditorGUILayout.EndVertical();
    }
    */

    /* DEPRECATED
    void LoadExampleUnityContent()
    {
        var exampleContent = new Dictionary<string, Dictionary<string, object>>
        {
            ["red_cube"] = new Dictionary<string, object>
            {
                ["question_1"] = new Dictionary<string, object>
                {
                    ["text"] = new Dictionary<string, object>
                    {
                        ["en"] = "What color is this cube?",
                        ["fr"] = "De quelle couleur est ce cube ?"
                    },
                    ["type"] = "multiple-choice",
                    ["options"] = new Dictionary<string, object>
                    {
                        ["en"] = new string[] { "Red", "Blue", "Green" },
                        ["fr"] = new string[] { "Rouge", "Bleu", "Vert" }
                    },
                    ["correctAnswer"] = 0,
                    ["feedback"] = new Dictionary<string, object>
                    {
                        ["en"] = "Correct! It's red.",
                        ["fr"] = "Correct ! C'est rouge."
                    },
                    ["incorrectFeedback"] = new Dictionary<string, object>
                    {
                        ["en"] = "Look closer at the color!",
                        ["fr"] = "Regardez mieux la couleur !"
                    }
                }
            },
            ["blue_sphere"] = new Dictionary<string, object>
            {
                ["question_1"] = new Dictionary<string, object>
                {
                    ["text"] = new Dictionary<string, object>
                    {
                        ["en"] = "Is this shape a sphere?",
                        ["fr"] = "Cette forme est-elle une sph√®re ?"
                    },
                    ["type"] = "true-false",
                    ["correctAnswer"] = 1,
                    ["feedback"] = new Dictionary<string, object>
                    {
                        ["en"] = "Exactly! It's a sphere.",
                        ["fr"] = "Exactement ! C'est une sph√®re."
                    },
                    ["incorrectFeedback"] = new Dictionary<string, object>
                    {
                        ["en"] = "Look carefully at the shape!",
                        ["fr"] = "Regardez attentivement la forme !"
                    }
                }
            }
        };
        
        unityContentJSON = JsonConvert.SerializeObject(exampleContent, Formatting.Indented);
        ValidateUnityContent();
        ShowNotification(new GUIContent("Multi-language example loaded!"));
    }
    */

    void DrawStringList(string label, List<string> list)
    {
        EditorGUILayout.LabelField(label, EditorStyles.boldLabel);
        
        for (int i = 0; i < list.Count; i++)
        {
            EditorGUILayout.BeginHorizontal();
            list[i] = EditorGUILayout.TextField($"  [{i}]", list[i]);
            if (GUILayout.Button("‚ùå", GUILayout.Width(25)))
            {
                list.RemoveAt(i);
                break;
            }
            EditorGUILayout.EndHorizontal();
        }
        
        if (GUILayout.Button($"‚ûï Add {label}"))
        {
            list.Add("");
        }
        
        EditorGUILayout.Space();
    }

    void DrawScenariosTab()
    {
        EditorGUILayout.LabelField("üé¨ Scenario Configuration", EditorStyles.largeLabel);
        EditorGUILayout.HelpBox("Configure your training scenarios visually. Choose type (Question/Procedure/Text), configure parameters, and export to metadata.json.", MessageType.Info);
        EditorGUILayout.Space();

        // Add scenario button
        if (GUILayout.Button("‚ûï Add New Scenario", GUILayout.Height(30)))
        {
            scenarios.Add(new WiseTwin.Editor.ScenarioConfiguration());
            selectedScenarioIndex = scenarios.Count - 1;
        }

        EditorGUILayout.Space();

        if (scenarios.Count == 0)
        {
            EditorGUILayout.HelpBox("No scenarios yet. Click 'Add New Scenario' to get started!", MessageType.Info);
            return;
        }

        // Scenario list with delete buttons
        EditorGUILayout.LabelField($"Scenarios ({scenarios.Count})", EditorStyles.boldLabel);

        for (int i = 0; i < scenarios.Count; i++)
        {
            EditorGUILayout.BeginHorizontal("box");

            // Select button
            GUI.backgroundColor = (selectedScenarioIndex == i) ? new Color(0.4f, 0.8f, 1f) : Color.white;
            if (GUILayout.Button($"{i + 1}. {scenarios[i].id} ({scenarios[i].type})", GUILayout.Height(25)))
            {
                selectedScenarioIndex = i;
            }
            GUI.backgroundColor = Color.white;

            // Delete button
            GUI.backgroundColor = new Color(1f, 0.4f, 0.4f);
            if (GUILayout.Button("üóë", GUILayout.Width(30), GUILayout.Height(25)))
            {
                if (EditorUtility.DisplayDialog("Delete Scenario", $"Delete scenario '{scenarios[i].id}'?", "Delete", "Cancel"))
                {
                    scenarios.RemoveAt(i);
                    if (selectedScenarioIndex >= scenarios.Count)
                    {
                        selectedScenarioIndex = scenarios.Count - 1;
                    }
                }
            }
            GUI.backgroundColor = Color.white;

            EditorGUILayout.EndHorizontal();
        }

        EditorGUILayout.Space();

        // Edit selected scenario
        if (selectedScenarioIndex >= 0 && selectedScenarioIndex < scenarios.Count)
        {
            DrawScenarioEditor(scenarios[selectedScenarioIndex]);
        }
    }

    void DrawScenarioEditor(WiseTwin.Editor.ScenarioConfiguration scenario)
    {
        EditorGUILayout.LabelField("Edit Scenario", EditorStyles.boldLabel);
        EditorGUI.DrawRect(EditorGUILayout.GetControlRect(false, 1), Color.gray);
        EditorGUILayout.Space();

        scenarioScrollPosition = EditorGUILayout.BeginScrollView(scenarioScrollPosition, GUILayout.Height(500));

        // Basic info
        EditorGUILayout.LabelField("Basic Information", EditorStyles.boldLabel);
        scenario.id = EditorGUILayout.TextField("Scenario ID", scenario.id);
        scenario.type = (WiseTwin.Editor.ScenarioType)EditorGUILayout.EnumPopup("Type", scenario.type);
        scenario.evaluationMode = EditorGUILayout.Toggle("Evaluation Mode", scenario.evaluationMode);

        EditorGUILayout.Space();

        // Type-specific fields
        switch (scenario.type)
        {
            case WiseTwin.Editor.ScenarioType.Question:
                DrawQuestionEditor(scenario.questionData);
                break;
            case WiseTwin.Editor.ScenarioType.Procedure:
                DrawProcedureEditor(scenario.procedureData);
                break;
            case WiseTwin.Editor.ScenarioType.Text:
                DrawTextEditor(scenario.textData);
                break;
        }

        EditorGUILayout.EndScrollView();
    }

    void DrawQuestionEditor(WiseTwin.Editor.QuestionScenarioData question)
    {
        EditorGUILayout.LabelField("Question Configuration", EditorStyles.boldLabel);

        // Question text
        EditorGUILayout.LabelField("Question Text", EditorStyles.miniBoldLabel);
        question.questionTextEN = EditorGUILayout.TextArea(question.questionTextEN, GUILayout.Height(60));
        EditorGUILayout.LabelField("  (English)", EditorStyles.miniLabel);
        question.questionTextFR = EditorGUILayout.TextArea(question.questionTextFR, GUILayout.Height(60));
        EditorGUILayout.LabelField("  (Fran√ßais)", EditorStyles.miniLabel);

        EditorGUILayout.Space();

        // Question type
        question.isMultipleChoice = EditorGUILayout.Toggle("Multiple Choice (plusieurs r√©ponses)", question.isMultipleChoice);

        EditorGUILayout.Space();

        // Options
        EditorGUILayout.LabelField("Options", EditorStyles.miniBoldLabel);

        int optionsCount = Mathf.Max(question.optionsEN.Count, question.optionsFR.Count);

        for (int i = 0; i < optionsCount; i++)
        {
            EditorGUILayout.BeginVertical("box");
            EditorGUILayout.BeginHorizontal();
            EditorGUILayout.LabelField($"Option {i + 1}", EditorStyles.boldLabel, GUILayout.Width(80));

            // Toggle pour correct answer
            bool isCorrect = question.correctAnswers.Contains(i);
            bool newIsCorrect = EditorGUILayout.Toggle("Correct", isCorrect, GUILayout.Width(80));
            if (newIsCorrect != isCorrect)
            {
                if (newIsCorrect)
                {
                    if (!question.isMultipleChoice)
                    {
                        question.correctAnswers.Clear();
                    }
                    question.correctAnswers.Add(i);
                }
                else
                {
                    question.correctAnswers.Remove(i);
                }
            }

            // Delete button
            GUI.backgroundColor = new Color(1f, 0.4f, 0.4f);
            if (GUILayout.Button("√ó", GUILayout.Width(25)))
            {
                question.optionsEN.RemoveAt(i);
                question.optionsFR.RemoveAt(i);
                question.correctAnswers.Remove(i);
                // Adjust indices in correctAnswers
                for (int j = 0; j < question.correctAnswers.Count; j++)
                {
                    if (question.correctAnswers[j] > i)
                    {
                        question.correctAnswers[j]--;
                    }
                }
                GUI.backgroundColor = Color.white;
                EditorGUILayout.EndHorizontal();
                EditorGUILayout.EndVertical();
                break;
            }
            GUI.backgroundColor = Color.white;

            EditorGUILayout.EndHorizontal();

            // Ensure lists have enough elements
            while (question.optionsEN.Count <= i) question.optionsEN.Add("");
            while (question.optionsFR.Count <= i) question.optionsFR.Add("");

            question.optionsEN[i] = EditorGUILayout.TextField("  EN", question.optionsEN[i]);
            question.optionsFR[i] = EditorGUILayout.TextField("  FR", question.optionsFR[i]);
            EditorGUILayout.EndVertical();
        }

        if (GUILayout.Button("‚ûï Add Option"))
        {
            question.optionsEN.Add("");
            question.optionsFR.Add("");
        }

        EditorGUILayout.Space();

        // Feedback
        EditorGUILayout.LabelField("Feedback Messages", EditorStyles.miniBoldLabel);
        EditorGUILayout.LabelField("Success Feedback:", EditorStyles.miniLabel);
        question.feedbackEN = EditorGUILayout.TextArea(question.feedbackEN, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (English)", EditorStyles.miniLabel);
        question.feedbackFR = EditorGUILayout.TextArea(question.feedbackFR, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (Fran√ßais)", EditorStyles.miniLabel);

        EditorGUILayout.Space();

        EditorGUILayout.LabelField("Error Feedback:", EditorStyles.miniLabel);
        question.incorrectFeedbackEN = EditorGUILayout.TextArea(question.incorrectFeedbackEN, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (English)", EditorStyles.miniLabel);
        question.incorrectFeedbackFR = EditorGUILayout.TextArea(question.incorrectFeedbackFR, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (Fran√ßais)", EditorStyles.miniLabel);

        EditorGUILayout.Space();

        // Hint (optional)
        EditorGUILayout.LabelField("Hint (Optional)", EditorStyles.miniBoldLabel);
        question.hintEN = EditorGUILayout.TextField("  EN", question.hintEN);
        question.hintFR = EditorGUILayout.TextField("  FR", question.hintFR);
    }

    void DrawProcedureEditor(WiseTwin.Editor.ProcedureScenarioData procedure)
    {
        EditorGUILayout.LabelField("Procedure Configuration", EditorStyles.boldLabel);

        // Title & Description
        EditorGUILayout.LabelField("Title", EditorStyles.miniBoldLabel);
        procedure.titleEN = EditorGUILayout.TextField("  EN", procedure.titleEN);
        procedure.titleFR = EditorGUILayout.TextField("  FR", procedure.titleFR);

        EditorGUILayout.Space();

        EditorGUILayout.LabelField("Description", EditorStyles.miniBoldLabel);
        procedure.descriptionEN = EditorGUILayout.TextArea(procedure.descriptionEN, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (English)", EditorStyles.miniLabel);
        procedure.descriptionFR = EditorGUILayout.TextArea(procedure.descriptionFR, GUILayout.Height(40));
        EditorGUILayout.LabelField("  (Fran√ßais)", EditorStyles.miniLabel);

        EditorGUILayout.Space();

        // Settings
        EditorGUILayout.LabelField("Settings", EditorStyles.miniBoldLabel);
        procedure.allowSkipSteps = EditorGUILayout.Toggle("Allow Skip Steps", procedure.allowSkipSteps);
        procedure.showStepNumbers = EditorGUILayout.Toggle("Show Step Numbers", procedure.showStepNumbers);
        procedure.requireSequentialOrder = EditorGUILayout.Toggle("Require Sequential Order", procedure.requireSequentialOrder);

        EditorGUILayout.Space();

        // Steps
        EditorGUILayout.LabelField("Steps", EditorStyles.boldLabel);
        for (int i = 0; i < procedure.steps.Count; i++)
        {
            DrawProcedureStep(procedure.steps[i], i, procedure.steps);
        }

        if (GUILayout.Button("‚ûï Add Step", GUILayout.Height(25)))
        {
            procedure.steps.Add(new WiseTwin.Editor.ProcedureStep());
        }

        EditorGUILayout.Space();

        // Fake Objects
        EditorGUILayout.LabelField("Fake Objects (Errors)", EditorStyles.boldLabel);
        for (int i = 0; i < procedure.fakeObjects.Count; i++)
        {
            DrawFakeObject(procedure.fakeObjects[i], i, procedure.fakeObjects);
        }

        if (GUILayout.Button("‚ûï Add Fake Object", GUILayout.Height(25)))
        {
            procedure.fakeObjects.Add(new WiseTwin.Editor.FakeObject());
        }
    }

    void DrawProcedureStep(WiseTwin.Editor.ProcedureStep step, int index, List<WiseTwin.Editor.ProcedureStep> steps)
    {
        EditorGUILayout.BeginVertical("box");

        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.LabelField($"Step {index + 1}", EditorStyles.boldLabel);
        GUI.backgroundColor = new Color(1f, 0.4f, 0.4f);
        if (GUILayout.Button("√ó", GUILayout.Width(25)))
        {
            steps.RemoveAt(index);
            GUI.backgroundColor = Color.white;
            EditorGUILayout.EndHorizontal();
            EditorGUILayout.EndVertical();
            return;
        }
        GUI.backgroundColor = Color.white;
        EditorGUILayout.EndHorizontal();

        // Target Object
        EditorGUI.BeginChangeCheck();
        step.targetObject = (GameObject)EditorGUILayout.ObjectField("Target Object", step.targetObject, typeof(GameObject), true);
        if (EditorGUI.EndChangeCheck() && step.targetObject != null)
        {
            step.targetObjectName = step.targetObject.name;
        }
        step.targetObjectName = EditorGUILayout.TextField("Object Name", step.targetObjectName);

        // Step text
        EditorGUILayout.LabelField("Text", EditorStyles.miniLabel);
        step.textEN = EditorGUILayout.TextField("  EN", step.textEN);
        step.textFR = EditorGUILayout.TextField("  FR", step.textFR);

        // Highlight
        step.highlightColor = EditorGUILayout.ColorField("Highlight Color", step.highlightColor);
        step.useBlinking = EditorGUILayout.Toggle("Use Blinking", step.useBlinking);

        // Hint
        EditorGUILayout.LabelField("Hint (Optional)", EditorStyles.miniLabel);
        step.hintEN = EditorGUILayout.TextField("  EN", step.hintEN);
        step.hintFR = EditorGUILayout.TextField("  FR", step.hintFR);

        EditorGUILayout.EndVertical();
        EditorGUILayout.Space();
    }

    void DrawFakeObject(WiseTwin.Editor.FakeObject fake, int index, List<WiseTwin.Editor.FakeObject> fakes)
    {
        EditorGUILayout.BeginVertical("box");

        EditorGUILayout.BeginHorizontal();
        EditorGUILayout.LabelField($"Fake #{index + 1}", EditorStyles.boldLabel);
        GUI.backgroundColor = new Color(1f, 0.4f, 0.4f);
        if (GUILayout.Button("√ó", GUILayout.Width(25)))
        {
            fakes.RemoveAt(index);
            GUI.backgroundColor = Color.white;
            EditorGUILayout.EndHorizontal();
            EditorGUILayout.EndVertical();
            return;
        }
        GUI.backgroundColor = Color.white;
        EditorGUILayout.EndHorizontal();

        EditorGUI.BeginChangeCheck();
        fake.fakeObject = (GameObject)EditorGUILayout.ObjectField("GameObject", fake.fakeObject, typeof(GameObject), true);
        if (EditorGUI.EndChangeCheck() && fake.fakeObject != null)
        {
            fake.fakeObjectName = fake.fakeObject.name;
        }
        fake.fakeObjectName = EditorGUILayout.TextField("Object Name", fake.fakeObjectName);

        EditorGUILayout.LabelField("Error Message", EditorStyles.miniLabel);
        fake.errorMessageEN = EditorGUILayout.TextField("  EN", fake.errorMessageEN);
        fake.errorMessageFR = EditorGUILayout.TextField("  FR", fake.errorMessageFR);

        EditorGUILayout.EndVertical();
        EditorGUILayout.Space();
    }

    void DrawTextEditor(WiseTwin.Editor.TextScenarioData text)
    {
        EditorGUILayout.LabelField("Text/Information Configuration", EditorStyles.boldLabel);

        EditorGUILayout.LabelField("Title", EditorStyles.miniBoldLabel);
        text.titleEN = EditorGUILayout.TextField("  EN", text.titleEN);
        text.titleFR = EditorGUILayout.TextField("  FR", text.titleFR);

        EditorGUILayout.Space();

        EditorGUILayout.LabelField("Content", EditorStyles.miniBoldLabel);
        text.contentEN = EditorGUILayout.TextArea(text.contentEN, GUILayout.Height(150));
        EditorGUILayout.LabelField("  (English)", EditorStyles.miniLabel);
        text.contentFR = EditorGUILayout.TextArea(text.contentFR, GUILayout.Height(150));
        EditorGUILayout.LabelField("  (Fran√ßais)", EditorStyles.miniLabel);
    }

    void DrawBottomButtons()
    {
        EditorGUILayout.Space();
        EditorGUI.DrawRect(EditorGUILayout.GetControlRect(false, 1), Color.gray);
        EditorGUILayout.Space();
        
        EditorGUILayout.BeginHorizontal();
        
        if (GUILayout.Button("üîç Preview JSON", GUILayout.Height(30)))
        {
            ShowJSONPreview();
        }
        
        if (GUILayout.Button("üíæ Generate Metadata", GUILayout.Height(30)))
        {
            GenerateMetadata();
        }
        
        EditorGUILayout.EndHorizontal();
    }
    
    FormationMetadataComplete GenerateCompleteMetadata()
    {
        var metadata = new FormationMetadataComplete
        {
            id = sceneId,
            title = new LocalizedString(projectTitleEN, projectTitleFR),
            description = new LocalizedString(projectDescriptionEN, projectDescriptionFR),
            version = projectVersion,
            duration = $"{durationMinutes} minutes", // Auto formatting
            difficulty = difficultyOptions[difficultyIndex], // Get from dropdown (d√©j√† en fran√ßais)
            tags = new List<string>(tags),
            imageUrl = imageUrl,
            modules = new List<object>(),
            createdAt = includeTimestamp ? System.DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ") : "",
            updatedAt = includeTimestamp ? System.DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ") : ""
        };

        // üéØ SIMPLIFIED STRUCTURE: Unity contains objects directly (legacy)
        try
        {
            if (!string.IsNullOrEmpty(unityContentJSON) && isUnityContentValid)
            {
                // Parse JSON directly to unity section
                metadata.unity = JsonConvert.DeserializeObject<Dictionary<string, Dictionary<string, object>>>(unityContentJSON);
            }
            else
            {
                // If no Unity content, create empty section
                metadata.unity = new Dictionary<string, Dictionary<string, object>>();
            }
        }
        catch (System.Exception e)
        {
            Debug.LogError($"Error parsing Unity content: {e.Message}");
            metadata.unity = new Dictionary<string, Dictionary<string, object>>();
        }

        // üéØ NEW: Convert scenarios to JSON format
        if (scenarios != null && scenarios.Count > 0)
        {
            metadata.scenarios = ConvertScenariosToJSON();

            // Check if any scenario has evaluationMode enabled
            bool hasEvaluationMode = scenarios.Any(s => s.evaluationMode);
            if (hasEvaluationMode)
            {
                metadata.settings = new Dictionary<string, object>
                {
                    ["evaluationMode"] = false, // Global default, can be overridden per scenario
                    ["allowPause"] = true,
                    ["showTimer"] = true,
                    ["showProgress"] = true
                };
            }
        }

        return metadata;
    }

    List<object> ConvertScenariosToJSON()
    {
        var scenariosJSON = new List<object>();

        foreach (var scenario in scenarios)
        {
            var scenarioDict = new Dictionary<string, object>
            {
                ["id"] = scenario.id,
                ["type"] = scenario.type.ToString().ToLower()
            };

            // Add evaluationMode if enabled
            if (scenario.evaluationMode)
            {
                scenarioDict["evaluationMode"] = true;
            }

            // Add content based on type
            switch (scenario.type)
            {
                case WiseTwin.Editor.ScenarioType.Question:
                    scenarioDict["question"] = ConvertQuestionDataToJSON(scenario.questionData);
                    break;

                case WiseTwin.Editor.ScenarioType.Procedure:
                    scenarioDict["procedure"] = ConvertProcedureDataToJSON(scenario.procedureData);
                    break;

                case WiseTwin.Editor.ScenarioType.Text:
                    scenarioDict["text"] = ConvertTextDataToJSON(scenario.textData);
                    break;
            }

            scenariosJSON.Add(scenarioDict);
        }

        return scenariosJSON;
    }

    Dictionary<string, object> ConvertQuestionDataToJSON(WiseTwin.Editor.QuestionScenarioData question)
    {
        var questionDict = new Dictionary<string, object>
        {
            ["questionText"] = new Dictionary<string, string>
            {
                ["en"] = question.questionTextEN,
                ["fr"] = question.questionTextFR
            },
            ["options"] = new Dictionary<string, object>
            {
                ["en"] = new List<string>(question.optionsEN),
                ["fr"] = new List<string>(question.optionsFR)
            },
            ["correctAnswers"] = new List<int>(question.correctAnswers),
            ["isMultipleChoice"] = question.isMultipleChoice
        };

        // Add feedback if provided
        if (!string.IsNullOrEmpty(question.feedbackEN) || !string.IsNullOrEmpty(question.feedbackFR))
        {
            questionDict["feedback"] = new Dictionary<string, string>
            {
                ["en"] = question.feedbackEN,
                ["fr"] = question.feedbackFR
            };
        }

        if (!string.IsNullOrEmpty(question.incorrectFeedbackEN) || !string.IsNullOrEmpty(question.incorrectFeedbackFR))
        {
            questionDict["incorrectFeedback"] = new Dictionary<string, string>
            {
                ["en"] = question.incorrectFeedbackEN,
                ["fr"] = question.incorrectFeedbackFR
            };
        }

        // Add hint if provided
        if (!string.IsNullOrEmpty(question.hintEN) || !string.IsNullOrEmpty(question.hintFR))
        {
            questionDict["hint"] = new Dictionary<string, string>
            {
                ["en"] = question.hintEN,
                ["fr"] = question.hintFR
            };
        }

        return questionDict;
    }

    Dictionary<string, object> ConvertProcedureDataToJSON(WiseTwin.Editor.ProcedureScenarioData procedure)
    {
        var procedureDict = new Dictionary<string, object>
        {
            ["title"] = new Dictionary<string, string>
            {
                ["en"] = procedure.titleEN,
                ["fr"] = procedure.titleFR
            },
            ["description"] = new Dictionary<string, string>
            {
                ["en"] = procedure.descriptionEN,
                ["fr"] = procedure.descriptionFR
            },
            ["steps"] = ConvertProcedureStepsToJSON(procedure.steps),
            ["allowSkipSteps"] = procedure.allowSkipSteps,
            ["showStepNumbers"] = procedure.showStepNumbers,
            ["requireSequentialOrder"] = procedure.requireSequentialOrder
        };

        // Add fake objects if any
        if (procedure.fakeObjects != null && procedure.fakeObjects.Count > 0)
        {
            procedureDict["fakeObjects"] = ConvertFakeObjectsToJSON(procedure.fakeObjects);
        }

        return procedureDict;
    }

    List<object> ConvertProcedureStepsToJSON(List<WiseTwin.Editor.ProcedureStep> steps)
    {
        var stepsJSON = new List<object>();

        foreach (var step in steps)
        {
            var stepDict = new Dictionary<string, object>
            {
                ["text"] = new Dictionary<string, string>
                {
                    ["en"] = step.textEN,
                    ["fr"] = step.textFR
                },
                ["targetObjectName"] = step.targetObjectName,
                ["highlightColor"] = ColorToHex(step.highlightColor),
                ["useBlinking"] = step.useBlinking
            };

            // Add hint if provided
            if (!string.IsNullOrEmpty(step.hintEN) || !string.IsNullOrEmpty(step.hintFR))
            {
                stepDict["hint"] = new Dictionary<string, string>
                {
                    ["en"] = step.hintEN,
                    ["fr"] = step.hintFR
                };
            }

            stepsJSON.Add(stepDict);
        }

        return stepsJSON;
    }

    List<object> ConvertFakeObjectsToJSON(List<WiseTwin.Editor.FakeObject> fakeObjects)
    {
        var fakeObjectsJSON = new List<object>();

        foreach (var fake in fakeObjects)
        {
            if (string.IsNullOrEmpty(fake.fakeObjectName))
                continue;

            fakeObjectsJSON.Add(new Dictionary<string, object>
            {
                ["objectName"] = fake.fakeObjectName,
                ["errorMessage"] = new Dictionary<string, string>
                {
                    ["en"] = fake.errorMessageEN,
                    ["fr"] = fake.errorMessageFR
                }
            });
        }

        return fakeObjectsJSON;
    }

    Dictionary<string, object> ConvertTextDataToJSON(WiseTwin.Editor.TextScenarioData text)
    {
        return new Dictionary<string, object>
        {
            ["title"] = new Dictionary<string, string>
            {
                ["en"] = text.titleEN,
                ["fr"] = text.titleFR
            },
            ["content"] = new Dictionary<string, string>
            {
                ["en"] = text.contentEN,
                ["fr"] = text.contentFR
            }
        };
    }

    string ColorToHex(Color color)
    {
        return $"#{ColorUtility.ToHtmlStringRGB(color)}";
    }
    
    void ShowJSONPreview()
    {
        var metadata = GenerateCompleteMetadata();
        string json = JsonConvert.SerializeObject(metadata, Formatting.Indented);
        
        MetadataPreviewWindow.ShowWindow(json);
    }
    
    void GenerateMetadata()
    {
        // Create StreamingAssets folder if it doesn't exist
        string streamingAssetsPath = Application.streamingAssetsPath;
        if (!Directory.Exists(streamingAssetsPath))
        {
            Directory.CreateDirectory(streamingAssetsPath);
        }
        
        var metadata = GenerateCompleteMetadata();
        string json = JsonConvert.SerializeObject(metadata, Formatting.Indented);
        
        string fileName = $"{sceneId}-metadata.json";
        string fullPath = Path.Combine(streamingAssetsPath, fileName);
        
        File.WriteAllText(fullPath, json);
        AssetDatabase.Refresh();
        
        EditorUtility.DisplayDialog("Generation Successful", 
            $"Metadata generated successfully!\n\n" +
            $"üìÅ File: {fileName}\n" +
            $"üìç Location: StreamingAssets/\n" +
            $"üéØ File will be automatically included in Unity build.", 
            "Perfect!");
            
        // Mark as loaded for next opening
        currentLoadedFile = fileName;
        hasLoadedExistingJSON = true;
    }
    
    
    async void DownloadMetadataFromAPI()
    {
        if (string.IsNullOrEmpty(azureApiUrl) || string.IsNullOrEmpty(containerId))
        {
            EditorUtility.DisplayDialog("Error",
                "Please configure API URL and Container ID first!",
                "OK");
            return;
        }

        // Construire l'URL avec les param√®tres
        string url = $"{azureApiUrl}?buildName={UnityEngine.Networking.UnityWebRequest.EscapeURL(sceneId)}" +
                     $"&buildType={UnityEngine.Networking.UnityWebRequest.EscapeURL(buildType)}" +
                     $"&containerId={UnityEngine.Networking.UnityWebRequest.EscapeURL(containerId)}";

        EditorUtility.DisplayProgressBar("Downloading Metadata", "Connecting to API...", 0.1f);

        try
        {
            using (var client = new System.Net.Http.HttpClient())
            {
                client.Timeout = System.TimeSpan.FromSeconds(30);

                Debug.Log($"üì• Downloading from: {url}");

                var response = await client.GetAsync(url);

                EditorUtility.DisplayProgressBar("Downloading Metadata", "Receiving data...", 0.5f);

                if (response.IsSuccessStatusCode)
                {
                    string jsonContent = await response.Content.ReadAsStringAsync();

                    // Parser la r√©ponse API
                    var apiResponse = JsonConvert.DeserializeObject<Dictionary<string, object>>(jsonContent);

                    string metadataJson;

                    // Si l'API retourne {success: true, data: {...}}
                    if (apiResponse.ContainsKey("success") && apiResponse.ContainsKey("data"))
                    {
                        metadataJson = JsonConvert.SerializeObject(apiResponse["data"], Formatting.Indented);
                    }
                    else
                    {
                        // Sinon on prend la r√©ponse directement
                        metadataJson = jsonContent;
                    }

                    // Sauvegarder dans StreamingAssets
                    string streamingAssetsPath = Path.Combine(Application.dataPath, "StreamingAssets");
                    if (!Directory.Exists(streamingAssetsPath))
                    {
                        Directory.CreateDirectory(streamingAssetsPath);
                    }

                    string fileName = $"{sceneId}-metadata.json";
                    string filePath = Path.Combine(streamingAssetsPath, fileName);

                    File.WriteAllText(filePath, metadataJson);

                    EditorUtility.DisplayProgressBar("Downloading Metadata", "Saved to StreamingAssets!", 1f);

                    AssetDatabase.Refresh();

                    Debug.Log($"‚úÖ Metadata downloaded and saved to: {filePath}");

                    EditorUtility.ClearProgressBar();

                    // Afficher le succ√®s et proposer de passer en mode Local
                    if (EditorUtility.DisplayDialog("Success",
                        $"Metadata downloaded successfully!\n\nSaved to: StreamingAssets/{fileName}\n\n" +
                        "Do you want to switch to Local Mode now?",
                        "Yes, switch to Local", "No"))
                    {
                        useLocalMode = true;
                        ApplySettingsToScene();
                    }
                }
                else
                {
                    EditorUtility.ClearProgressBar();
                    string error = $"API Error: {response.StatusCode} - {response.ReasonPhrase}";
                    Debug.LogError($"‚ùå {error}");

                    string responseContent = await response.Content.ReadAsStringAsync();
                    Debug.LogError($"Response: {responseContent}");

                    EditorUtility.DisplayDialog("Download Failed", error, "OK");
                }
            }
        }
        catch (System.Exception e)
        {
            EditorUtility.ClearProgressBar();
            Debug.LogError($"‚ùå Download failed: {e.Message}");
            EditorUtility.DisplayDialog("Download Failed",
                $"Failed to download metadata:\n{e.Message}",
                "OK");
        }
    }

    void SyncWithSceneManager()
    {
        // Synchroniser l'√©tat de l'√©diteur avec le WiseTwinManager de la sc√®ne
        WiseTwin.WiseTwinManager manager = FindFirstObjectByType<WiseTwin.WiseTwinManager>();
        if (manager != null)
        {
            SerializedObject managerSO = new SerializedObject(manager);
            SerializedProperty prodModeProp = managerSO.FindProperty("useProductionMode");
            if (prodModeProp != null)
            {
                // Lire l'√©tat actuel du manager et synchroniser l'√©diteur
                useLocalMode = !prodModeProp.boolValue;
                Debug.Log($"[WiseTwinEditor] Synchronis√© avec WiseTwinManager: Mode {(useLocalMode ? "Local" : "Production")}");
            }
        }
    }

    void ApplyLocalModeToManager()
    {
        // Chercher le WiseTwinManager dans la sc√®ne
        WiseTwin.WiseTwinManager manager = FindFirstObjectByType<WiseTwin.WiseTwinManager>();
        if (manager != null)
        {
            // Appliquer le mode Production/Local
            SerializedObject managerSO = new SerializedObject(manager);
            SerializedProperty prodModeProp = managerSO.FindProperty("useProductionMode");
            if (prodModeProp != null)
            {
                prodModeProp.boolValue = !useLocalMode;  // Inverser car useLocalMode est l'oppos√© de useProductionMode
                managerSO.ApplyModifiedProperties();
                EditorUtility.SetDirty(manager);

                // Marquer la sc√®ne comme modifi√©e pour forcer la sauvegarde
                UnityEditor.SceneManagement.EditorSceneManager.MarkSceneDirty(manager.gameObject.scene);

                Debug.Log($"‚úÖ WiseTwinManager: Mode {(useLocalMode ? "Local" : "Production")} appliqu√© automatiquement et sc√®ne marqu√©e pour sauvegarde");
            }
        }
        else
        {
            Debug.LogWarning("‚ùå WiseTwinManager not found in scene! Please add WiseTwinManager to apply mode settings.");
        }
    }

    void ApplySettingsToScene()
    {
        // Appliquer le mode local/production
        ApplyLocalModeToManager();

        // Chercher le MetadataLoader dans la sc√®ne
        MetadataLoader loader = FindFirstObjectByType<MetadataLoader>();
        if (loader != null)
        {
            // Appliquer les param√®tres API
            loader.useAzureStorageDirect = useAzureStorageDirect;
            loader.azureStorageUrl = azureStorageUrl;
            loader.apiBaseUrl = azureApiUrl;
            loader.containerId = containerId;
            loader.buildType = buildType;
            loader.requestTimeout = requestTimeout;
            loader.maxRetryAttempts = maxRetryAttempts;

            Debug.Log($"‚úÖ MetadataLoader configured:");
            Debug.Log($"   - Mode: {(useLocalMode ? "Local" : "Production")}");
            Debug.Log($"   - Azure Direct: {useAzureStorageDirect}");
            if (useAzureStorageDirect)
            {
                Debug.Log($"   - Storage URL: {azureStorageUrl}");
            }
            else
            {
                Debug.Log($"   - API URL: {azureApiUrl}");
            }
            Debug.Log($"   - Container ID: {containerId}");
            Debug.Log($"   - Build Type: {buildType}");

            EditorUtility.SetDirty(loader);
        }
        else
        {
            Debug.LogWarning("‚ùå MetadataLoader not found in scene!");
        }

        // Sauvegarder les changements
        SaveSettings();

        EditorUtility.DisplayDialog("Success",
            $"Settings applied to scene!\n\nMode: {(useLocalMode ? "Local" : "Production")}\n" +
            $"API: {azureApiUrl}\n" +
            $"Container: {containerId}",
            "OK");
    }

    void OnDisable()
    {
        SaveSettings();
    }
}

// Preview window
public class MetadataPreviewWindow : EditorWindow
{
    private Vector2 scrollPosition;
    private string jsonContent;
    
    public static void ShowWindow(string json)
    {
        MetadataPreviewWindow window = GetWindow<MetadataPreviewWindow>("JSON Preview");
        window.jsonContent = json;
        window.minSize = new Vector2(500, 400);
        window.Show();
    }
    
    void OnGUI()
    {
        EditorGUILayout.LabelField("üìã Metadata JSON Preview", EditorStyles.largeLabel);
        EditorGUILayout.Space();
        
        EditorGUILayout.BeginHorizontal();
        if (GUILayout.Button("üìã Copy JSON"))
        {
            EditorGUIUtility.systemCopyBuffer = jsonContent;
            ShowNotification(new GUIContent("JSON copied to clipboard!"));
        }
        if (GUILayout.Button("üíæ Save as..."))
        {
            string path = EditorUtility.SaveFilePanel("Save JSON", "", "metadata", "json");
            if (!string.IsNullOrEmpty(path))
            {
                File.WriteAllText(path, jsonContent);
                ShowNotification(new GUIContent($"Saved: {path}"));
            }
        }
        EditorGUILayout.EndHorizontal();
        
        EditorGUILayout.Space();
        
        scrollPosition = EditorGUILayout.BeginScrollView(scrollPosition);
        EditorGUILayout.TextArea(jsonContent, GUILayout.ExpandHeight(true));
        EditorGUILayout.EndScrollView();
    }
}

#endif